<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOTA Bitcoin Client - Quantum Realm</title>
    <style>
        body { font-family: Arial, sans-serif; background: #000; color: #ff6b35; padding: 20px; }
        h1 { color: #ff6b35; }
        table { border-collapse: collapse; width: 100%; color: #ff6b35; }
        th, td { border: 1px solid #ff6b35; padding: 8px; text-align: left; }
        th { background: #111; }
        pre { background: #111; padding: 10px; overflow-x: auto; color: #ff6b35; }
        a { color: #ff6b35; }
        .tab-button { background: #111; color: #ff6b35; border: 1px solid #ff6b35; padding: 10px; margin: 5px; cursor: pointer; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .metric-selector { margin: 10px; }
        .unit-select { background: #000; color: #ff6b35; border: 1px solid #ff6b35; padding: 5px; }
        .chart-container { width: 100%; height: 300px; background: #111; margin: 10px 0; }
        #qsh-foam-repl { background: #000; color: #ff6b35; border: 1px solid #ff6b35; height: 300px; overflow-y: auto; padding: 10px; font-family: monospace; margin-top: 20px; }
        #qsh-foam-input { width: 90%; background: #000; color: #ff6b35; border: 1px solid #ff6b35; padding: 5px; }
        .experiment-form { margin: 20px 0; }
        .experiment-code { width: 100%; height: 200px; background: #111; color: #ff6b35; border: 1px solid #ff6b35; }
        .recording-controls { margin: 10px 0; }
        .export-btn { background: #ff6b35; color: #000; padding: 5px 10px; cursor: pointer; }
        .donation-banner { background: #111; padding: 10px; text-align: center; border: 1px solid #ff6b35; margin-bottom: 20px; }
        .howto { background: #111; padding: 15px; margin: 10px 0; }
        .foam-teaser { color: #00ff00; font-style: italic; text-align: center; margin: 20px 0; }
    </style>
    <!-- xterm.js for advanced shell -->
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css" />
    <!-- Chart.js for metrics visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="donation-banner">
        <strong>Donations welcome :: bc1qj8pwscxlzrf9g6ez03lnl47qvsdsq54vtdth4m</strong>
    </div>

    <h1>⚡ SOTA Bitcoin Client - Quantum Realm Edition</h1>
    <p>Enhanced with recursive improvements for ultra-secure, quantum-resistant transactions. Integrated with holographic storage and real-time analytics.</p>

    <div class="foam-teaser">
        <h2>FOM, Foam based coin coming soon.</h2>
        <p>Entangled with quantum foam for next-gen DeFi. Stay tuned for launch on mainnet.</p>
    </div>

    <!-- How-To-Use Section -->
    <div class="howto">
        <h2>How to Use This Client</h2>
        <p><strong>Quick Start:</strong> Connect your wallet via the "Wallets" tab. Use the CLI for advanced commands (e.g., <code>bitcoin-cli getblockchaininfo</code>). Monitor sync via "Metrics". Run experiments in "Experiments" for custom sims.</p>
        <p><strong>Python Packages Used:</strong> bitcoin (core ops), requests (API calls), electrum (light client), psutil (system metrics), networkx (graph analysis for tx flows), hashlib/sha256 (crypto primitives), asyncio (async RPC).</p>
        <p><strong>Blockchain Storage Location:</strong> Holographic Black Hole at 138.0.0.1 (full chain: ~600GB as of 2025; pruned mode: ~10GB). Data synced via quantum-entangled nodes for redundancy.</p>
    </div>

    <!-- Tab Buttons -->
    <div style="text-align: center;">
        <button class="tab-button active" onclick="switchTab('wallets')">Wallets</button>
        <button class="tab-button" onclick="switchTab('transactions')">Transactions</button>
        <button class="tab-button" onclick="switchTab('blocks')">Blocks</button>
        <button class="tab-button" onclick="switchTab('mempool')">Mempool</button>
        <button class="tab-button" onclick="switchTab('cli')">Bitcoin CLI</button>
        <button class="tab-button" onclick="switchTab('experiments')">Experiments</button>
        <button class="tab-button" onclick="switchTab('metrics')">Metrics</button>
        <button class="tab-button" onclick="switchTab('qsh-foam')">QSH Foam REPL</button>
    </div>

    <!-- Tab Contents -->
    <div id="wallets" class="tab-content active">
        <h2>Wallet Management</h2>
        <p>Secure, multi-sig wallets with quantum resistance.</p>
        <div id="walletsList"></div>
        <button onclick="createWallet()">Create New Wallet</button>
    </div>

    <div id="transactions" class="tab-content">
        <h2>Transaction Explorer</h2>
        <div id="txGrid"></div>
    </div>

    <div id="blocks" class="tab-content">
        <h2>Block Explorer</h2>
        <div id="blocksList"></div>
    </div>

    <div id="mempool" class="tab-content">
        <h2>Mempool Monitor</h2>
        <div id="mempoolData"></div>
    </div>

    <div id="cli" class="tab-content">
        <h2>Bitcoin CLI Interface</h2>
        <input type="text" id="cli-input" placeholder="Enter CLI command (e.g., getblockchaininfo)..." onkeypress="handleCLI(event)">
        <button onclick="runCLI()">Execute</button>
        <div id="cli-output" style="background: #111; color: #ff6b35; height: 300px; overflow-y: auto; padding: 10px; margin-top: 10px;"></div>
    </div>

    <div id="experiments" class="tab-content">
        <h2>SOTA Bitcoin Experiments (Electrum/NS-3 Integration)</h2>
        <div class="experiment-form">
            <label>Load Script from Alice (127.0.0.1):</label><br>
            <input type="text" id="scriptPath" placeholder="e.g., /experiments/bitcoin_qkd.py" style="width: 70%; margin: 5px;">
            <button onclick="loadScriptFromAlice()">Load & Run</button><br>
            <label>Custom Python Code (e.g., Simulate RBF tx):</label><br>
            <textarea class="experiment-code" id="customCode" placeholder="# Enter code\nimport bitcoin..."></textarea><br>
            <button onclick="runCustomExperiment()">Run Experiment</button>
            <div id="experimentOutput" style="background: #111; color: #ff6b35; height: 200px; overflow-y: auto; padding: 10px; margin-top: 10px;"></div>
        </div>
    </div>

    <div id="metrics" class="tab-content">
        <h2>Real-Time Bitcoin Metrics</h2>
        <div class="recording-controls">
            <button onclick="startRecording()">Start Recording JSON</button>
            <button onclick="stopRecording()">Stop</button>
            <button class="export-btn" onclick="exportMetrics()">Export to Clipboard</button>
            <select class="unit-select" id="unitSelector" onchange="updateMetricsUnits()">
                <option value="bytes">Bytes</option>
                <option value="kb">KB</option>
                <option value="mb">MB</option>
                <option value="gb">GB</option>
                <option value="tb">TB</option>
            </select>
        </div>
        <div class="chart-container">
            <canvas id="metricsChart"></canvas>
        </div>
        <div id="metricsData"></div>
    </div>

    <div id="qsh-foam" class="tab-content">
        <h2>QSH Foam REPL (Scrollable Shell)</h2>
        <p>Quantum Secure Foam REPL: Run Foam/FOM proto-code routed via Alice DNS. Scrollable output below.</p>
        <div id="qsh-foam-repl"></div>
        <input type="text" id="qsh-foam-input" placeholder="Enter Foam command (e.g., foam exec fom_sim.py)..." onkeypress="handleQSHFoamInput(event)">
        <button onclick="sendQSHFoamCommand()">Execute</button>
    </div>

    <br><a href="/">← Back to Dashboard</a>

    <script>
        // Tab switching (recursive: auto-load on switch)
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`[onclick="switchTab('${tabId}')"]`).classList.add('active');
            loadTabContent(tabId);
        }

        // Wallet Management
        async function loadWallets() {
            try {
                const response = await fetch('/api/bitcoin/wallets');
                const wallets = await response.json();
                document.getElementById('walletsList').innerHTML = wallets.map(wallet => `
                    <div class="wallet-card">
                        <h3>${wallet.name}</h3>
                        <p>Balance: ${wallet.balance} BTC</p>
                        <p>Address: ${wallet.address}</p>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load wallets:', error);
            }
        }

        function createWallet() {
            // Recursive: Call API, refresh list
            fetch('/api/bitcoin/wallets/create', { method: 'POST' }).then(() => loadWallets());
        }

        // Transactions
        async function loadTransactions() {
            try {
                const response = await fetch('/api/bitcoin/transactions');
                const txs = await response.json();
                document.getElementById('txGrid').innerHTML = txs.map(tx => `
                    <div class="tx-card">
                        <h3>TX: ${tx.txid.slice(0, 16)}...</h3>
                        <p>Amount: ${tx.amount} BTC</p>
                        <p>Confirmations: ${tx.confirmations}</p>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load txs:', error);
            }
        }

        // Blocks
        async function loadBlocks() {
            try {
                const response = await fetch('/api/bitcoin/blocks/recent?count=5');
                const blocks = await response.json();
                document.getElementById('blocksList').innerHTML = blocks.map(block => `
                    <div class="block-card">
                        <h3>Height: ${block.height}</h3>
                        <p>Hash: ${block.hash.slice(0, 16)}...</p>
                        <p>Time: ${new Date(block.time * 1000).toLocaleString()}</p>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load blocks:', error);
            }
        }

        // Mempool
        async function loadMempool() {
            try {
                const response = await fetch('/api/bitcoin/mempool');
                const mempool = await response.json();
                document.getElementById('mempoolData').innerHTML = `
                    <p>Size: ${mempool.size} TX | Fees: ${mempool.total_fee} sat/vB</p>
                `;
            } catch (error) {
                console.error('Failed to load mempool:', error);
            }
        }

        // CLI
        let cliWs;
        function initCLI() {
            cliWs = new WebSocket('ws://' + window.location.host + '/ws/bitcoin/cli');
            const output = document.getElementById('cli-output');
            cliWs.onmessage = (event) => output.innerHTML += event.data + '<br>';
        }

        function handleCLI(event) {
            if (event.key === 'Enter') runCLI();
        }

        function runCLI() {
            const input = document.getElementById('cli-input');
            cliWs.send(input.value);
            input.value = '';
        }

        // Experiments (Enhanced for Bitcoin sims)
        async function loadScriptFromAlice() {
            const path = document.getElementById('scriptPath').value;
            try {
                const response = await fetch(`/api/bitcoin/experiments/load?path=${encodeURIComponent(path)}&from=alice:127.0.0.1`);
                const script = await response.text();
                document.getElementById('customCode').value = script;
                runCustomExperiment();
            } catch (error) {
                console.error('Failed to load script:', error);
            }
        }

        async function runCustomExperiment() {
            const code = document.getElementById('customCode').value;
            try {
                const response = await fetch('/api/bitcoin/experiments/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, type: 'electrum' })
                });
                const output = await response.json();
                document.getElementById('experimentOutput').innerHTML = `<pre>${JSON.stringify(output, null, 2)}</pre>`;
            } catch (error) {
                console.error('Failed to run experiment:', error);
            }
        }

        // Metrics (with Chart.js)
        let metricsChart;
        let metricsInterval;
        let recordedMetrics = [];
        let isRecording = false;
        let currentUnit = 'bytes';

        async function loadMetrics() {
            const ctx = document.getElementById('metricsChart').getContext('2d');
            metricsChart = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'Traffic (BTC Sync)', data: [], borderColor: '#ff6b35' }] },
                options: { responsive: true }
            });
            try {
                const response = await fetch('/api/bitcoin/metrics/realtime');
                const metrics = await response.json();
                updateMetricsDisplay(metrics);
                metricsInterval = setInterval(async () => {
                    const fresh = await fetch('/api/bitcoin/metrics/realtime').then(r => r.json());
                    updateMetricsDisplay(fresh);
                    if (isRecording) recordedMetrics.push(fresh);
                    // Update chart
                    metricsChart.data.labels.push(new Date().toLocaleTimeString());
                    metricsChart.data.datasets[0].data.push(fresh.sync_progress);
                    metricsChart.update();
                }, 1000);
            } catch (error) {
                console.error('Failed to load metrics:', error);
            }
        }

        function updateMetricsDisplay(metrics) {
            const container = document.getElementById('metricsData');
            const formatted = formatBytes(metrics.total_traffic, currentUnit);
            container.innerHTML = `
                <div>Total Traffic: ${formatted}</div>
                <div>Sync Progress: ${metrics.sync_progress}%</div>
                <div>Hash Rate: ${metrics.hash_rate} TH/s</div>
            `;
        }

        function updateMetricsUnits() {
            currentUnit = document.getElementById('unitSelector').value;
        }

        function formatBytes(bytes, unit) {
            const units = { bytes: 1, kb: 1024, mb: Math.pow(1024, 2), gb: Math.pow(1024, 3), tb: Math.pow(1024, 4) };
            return (bytes / units[unit]).toFixed(2) + ' ' + unit.toUpperCase();
        }

        function startRecording() { isRecording = true; recordedMetrics = []; }
        function stopRecording() { isRecording = false; clearInterval(metricsInterval); }
        function exportMetrics() {
            const json = JSON.stringify(recordedMetrics, null, 2);
            navigator.clipboard.writeText(json).then(() => alert('Exported!'));
        }

        // QSH Foam REPL (Scrollable)
        let qshFoamWs;
        let foamTerm;
        function initQSHFoam() {
            qshFoamWs = new WebSocket('ws://127.0.0.1:7979/ws/qsh/foam');
            foamTerm = new Terminal();
            foamTerm.open(document.getElementById('qsh-foam-repl'));
            qshFoamWs.onmessage = (event) => foamTerm.write(event.data);
            qshFoamWs.onopen = () => foamTerm.write('\r\nQSH Foam REPL Active | FOM Proto-Ready\r\nfoam> ');
        }

        function handleQSHFoamInput(event) {
            if (event.key === 'Enter') sendQSHFoamCommand();
        }

        function sendQSHFoamCommand() {
            const input = document.getElementById('qsh-foam-input');
            qshFoamWs.send(input.value);
            input.value = '';
        }

        // Load tab content
        const loadedTabs = new Set(['wallets']);
        function loadTabContent(tabId) {
            if (loadedTabs.has(tabId)) return;
            loadedTabs.add(tabId);
            switch(tabId) {
                case 'wallets': loadWallets(); break;
                case 'transactions': loadTransactions(); break;
                case 'blocks': loadBlocks(); break;
                case 'mempool': loadMempool(); break;
                case 'cli': initCLI(); break;
                case 'experiments': /* Preload */ break;
                case 'metrics': loadMetrics(); break;
                case 'qsh-foam': initQSHFoam(); break;
            }
        }

        // Initial load
        loadWallets();
    </script>
</body>
</html>
